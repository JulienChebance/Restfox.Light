name: Create new Windows Light release
on:
  workflow_dispatch:
  schedule:
    - cron: "50 3 * * *"
jobs:
  build:
    runs-on: windows-latest
    steps:
      - id: distantVersion
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: flawiddsouza/Restfox
          excludes: prerelease, draft
      - id: localVersion
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: JulienChebance/Restfox.Light

      - name: Checkout Restfox sources
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        uses: actions/checkout@v5
        with:
          repository: flawiddsouza/Restfox
          path: Restfox

      - name: Use Node.js
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        uses: actions/setup-node@v5
        with:
          node-version: latest

      - name: Install dependencies
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        run: npm install
        working-directory: Restfox/packages/ui

      - name: Create git tag v0.40.0
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        shell: pwsh
        run: |
          cd Restfox
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag v0.40.0

      - name: Build UI
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        run: npm run build
        working-directory: Restfox/packages/ui

      - name: Add notranslate meta tag
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        shell: pwsh
        run: |
          $indexPath = "Restfox/packages/ui/dist/index.html"
          (Get-Content $indexPath) -replace '<head>', '<head><meta name="google" content="notranslate">' | Set-Content $indexPath

      - name: Copy and modify LICENSE
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        shell: pwsh
        run: |
          $src = "Restfox/LICENSE"
          $dest = "Restfox/packages/ui/dist/LICENSE.txt"
          Copy-Item $src $dest -Force

          $lines = Get-Content $dest
          $output = @()
          foreach ($line in $lines) {
            $output += $line
            if ($line -match '^Copyright') {
              $output += 'Copyright (c) 2024+ Julien Chebance`n'
            }
          }
          $output | Set-Content $dest

      - name: Download web2exe
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/JulienChebance/web2exe/releases/latest/download/web2exe.zip" -OutFile "web2exe.zip"

      - name: Extract web2exe
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        shell: pwsh
        run: |
          Expand-Archive -Path "web2exe.zip" -DestinationPath "Restfox/packages/ui/dist" -Force

      - name: Setup MSBuild and CSC
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        uses: microsoft/setup-msbuild@v2

      - name: Run web2exe
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        shell: pwsh
        working-directory: Restfox/packages/ui
        run: |
          # Get product name from AssemblyInfo.cs as the file name
          $filename = ""
          Get-Content .\AssemblyInfo.cs | ForEach-Object {
            if ($_ -match '^\[assembly:\s*AssemblyProduct\("(.+)"\)\]') {
              $filename = $matches[1]
            }
          }
          if ([string]::IsNullOrEmpty($filename)) {
            $filename = "web2exe"
          }

          # Remove unauthorized characters
          $filename = $filename -replace "[:/\\?]", ""

          # Générer la liste des ressources
          $resources = @()
          Get-ChildItem -Recurse -File -Exclude *.exe,*.cs,*.bat | Where-Object {
            -not ($_.Name.StartsWith('.'))
          } | ForEach-Object {
            $resources += ('/res:"' + ($_.FullName -replace '\\','/') + '"')
          }
          $resourcesArgs = $resources -join ' '

          Write-Host "Loaded resources: $resourcesArgs"

          $icon = ""
          if (Test-Path ".\favicon.ico") {
            $icon = "/win32icon:favicon.ico"
          }

          # Compilation avec CSC
          $outFile = "$filename.exe"
          $csFiles = Get-ChildItem -Path . -Filter *.cs | ForEach-Object { $_.FullName }
          $csFilesArgs = $csFiles -join ' '

          $cmd = "$env:WINDIR\Microsoft.NET\Framework64\v4.0.30319\csc.exe /target:winexe -out:`"$outFile`" $csFilesArgs -optimize -nologo $icon $resourcesArgs"
          Write-Host "Running: $cmd"
          Invoke-Expression $cmd

          if ($LASTEXITCODE -eq 0) {
            Write-Host "The following file has been successfully created:"
            Write-Host $outFile
          } else {
            Write-Error "CSC compilation failed with exit code $LASTEXITCODE"
          }

      - name: Compress
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        uses: vimtor/action-zip@v1.2
        with:
          files: Restfox/packages/ui/dist/LICENSE.txt Restfox/packages/ui/dist/Restfox.exe
          dest: Restfox.Light.zip

      - name: Release
        if: ${{ steps.distantVersion.outputs.release }} != ${{ steps.localVersion.outputs.release }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.distantVersion.outputs.release }}
          name: "Restfox Light ${{ steps.distantVersion.outputs.release }}"
          files: Restfox.Light.zip
